# Data Engineering for Scaling Language Models to 128K Context


# Data Engineering for Scaling Language Models to 128K Context

***

## <span style="color: #1B5E20"><span style="background-color: #f1f8e9">💡 Meta Data</span></span>

| <span style="background-color: #dbeedd">Title</span>     | <span style="background-color: #dbeedd">Data Engineering for Scaling Language Models to 128K Context</span>                                                                                                 |
| -------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <span style="background-color: #f3faf4">Journal</span>   |                                                                                                                                                                                                             |
| <span style="background-color: #dbeedd">Authors</span>   | <span style="background-color: #dbeedd">Yao Fu; Rameswar Panda; Xinyao Niu; Xiang Yue; Hannaneh Hajishirzi; Yoon Kim; Hao Peng</span>                                                                       |
| <span style="background-color: #f3faf4">Pub. date</span> | <span style="background-color: #f3faf4">2024-02-15</span>                                                                                                                                                   |
| <span style="background-color: #dbeedd">期刊标签</span>      |                                                                                                                                                                                                             |
| <span style="background-color: #f3faf4">DOI</span>       | <span style="background-color: #f3faf4"><a href="https://doi.org/10.48550/arXiv.2402.10171" rel="noopener noreferrer nofollow">10.48550/arXiv.2402.10171</a></span>                                         |
| <span style="background-color: #dbeedd">附件</span>        | <span style="background-color: #dbeedd"><a href="zotero://open-pdf/0_Z5AQISDH" rel="noopener noreferrer nofollow">Fu et al_2024_Data Engineering for Scaling Language Models to 128K Context.pdf</a></span> |

## <span style="color: #E65100"><span style="background-color: #fff8e1">📜 研究背景 &#x26; 基础 &#x26; 目的</span></span>

***

<span style="color: rgb(6, 6, 7)"><span style="background-color: rgb(255, 255, 255)">论文主要研究了如何通过数据工程的方法，将语言模型的上下文长度扩展到128K个token。这项研究的重点在于数据工程，作者们提出了一个假设：长上下文建模的能力，特别是利用任意输入位置信息的能力，主要是通过大规模预训练获得的，并且这种能力可以通过轻量级的持续预训练在适当的数据混合上扩展到训练期间未见过的更长上下文（例如，从4K扩展到128K）。</span></span>

## <span style="color: #2E7D32"><span style="background-color: #f1f8e9">📊 研究内容</span></span>

***

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22CJM6DHQP%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%221%22%2C%22position%22%3A%7B%22pageIndex%22%3A0%2C%22rects%22%3A%5B%5B218.221%2C393.004%2C271.165%2C401.911%5D%2C%5B75.366%2C381.049%2C271.165%2C389.956%5D%2C%5B75.366%2C369.094%2C269.518%2C378.001%5D%2C%5B75.366%2C357.138%2C270.341%2C366.045%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=1&#x26;annotation=CJM6DHQP">“(1) for quantity, we show that 500 million to 5 billion tokens are enough to enable the model to retrieve information anywhere within the 128K context;”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 1</a></span>)</span> 数据量较少

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22T4THUP8D%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%221%22%2C%22position%22%3A%7B%22pageIndex%22%3A0%2C%22rects%22%3A%5B%5B75.037%2C345.183%2C271.169%2C354.09%5D%2C%5B75.366%2C333.228%2C270.764%2C342.135%5D%2C%5B75.007%2C321.273%2C269.512%2C330.23%5D%2C%5B75.366%2C309.318%2C269.518%2C318.225%5D%2C%5B75.366%2C297.363%2C270.761%2C306.27%5D%2C%5B75.366%2C285.407%2C271.165%2C294.314%5D%2C%5B75.366%2C273.452%2C93.149%2C282.359%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=1&#x26;annotation=T4THUP8D">“(2) for quality, our results equally emphasize domain balance and length upsampling. Concretely, we find that na ̈ıvely upsampling longer data on certain domains like books, a common practice of existing work, gives suboptimal performance, and that a balanced domain mixture is important.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 1</a></span>)</span> 对于质量来说使用上采样可以大幅提高能力

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22AHKRN8DL%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%221%22%2C%22position%22%3A%7B%22pageIndex%22%3A0%2C%22rects%22%3A%5B%5B307.082%2C529.114%2C541.445%2C538.021%5D%2C%5B307.44%2C517.158%2C541.437%2C526.065%5D%2C%5B307.44%2C505.203%2C541.438%2C514.11%5D%2C%5B306.115%2C493.248%2C355.629%2C502.155%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=1&#x26;annotation=AHKRN8DL">“which asks the model to precisely recite the information in a given sentence where the sentence (the “needle”) is placed in an arbitrary location of a 128K long document (the “haystack”).”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 1</a></span>)</span> 干草堆测试的定义

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22H3DCD7N4%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%221%22%2C%22position%22%3A%7B%22pageIndex%22%3A0%2C%22rects%22%3A%5B%5B325.054%2C331.853%2C463.996%2C340.76%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=1&#x26;annotation=H3DCD7N4">“attention has quadratic complexity”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 1</a></span>)</span> transformer原始注意力就是一个平方复杂度的注意力

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22NFME4Y23%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%221%22%2C%22position%22%3A%7B%22pageIndex%22%3A0%2C%22rects%22%3A%5B%5B306.972%2C194.369%2C541.436%2C203.276%5D%2C%5B307.44%2C182.414%2C542.108%2C191.321%5D%2C%5B307.44%2C170.458%2C543.093%2C179.365%5D%2C%5B307.44%2C158.503%2C484.139%2C167.41%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=1&#x26;annotation=NFME4Y23">“We hypothesize that the capability to utilize information at arbitrary locations within long context length is (mostly) already acquired during pretraining, even for models pretrained on substantially shorter 4K contexts.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%221%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 1</a></span>)</span> 作者认为模型在预训练过程就学习到了利用位置信息的能力

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22X5VSAXJP%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%222%22%2C%22position%22%3A%7B%22pageIndex%22%3A1%2C%22rects%22%3A%5B%5B55.44%2C295.099%2C291.093%2C304.006%5D%2C%5B55.44%2C283.144%2C181.377%2C292.051%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%222%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=2&#x26;annotation=X5VSAXJP">“because, as we observe, this results in perplexiy degradations in other domains (Table 5).”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%222%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 2</a></span>)</span> 只是单独对一个邻域的数据上采样会使得其它邻域的性能下降。

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%225QEXM69Z%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B450.837%2C695.966%2C541.439%2C703.982%5D%2C%5B55.162%2C685.007%2C261.661%2C693.023%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=5QEXM69Z">“we use 80K compared to Together’s 32K, which does not generalizes beyond 32K;”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 使用80k的上下文进行训练

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22XW9MQ3AJ%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B276.666%2C685.007%2C541.444%2C693.023%5D%2C%5B55.44%2C674.048%2C196.774%2C682.064%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=XW9MQ3AJ">“data mixture: we use SlimPajama which has balanced domains compared to YaRN, which uses book-only PG19;”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 使用邻域数据更平衡的混合数据集

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22KCAPRVRH%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B211.846%2C674.048%2C543.006%2C682.064%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=KCAPRVRH">“length upsampling: we upsample long sequences compared to LongLoRA, which does not.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 邻域数据进行平衡性的长文本上采样

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22Y3JBRINU%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B55.082%2C223.737%2C289.8%2C232.644%5D%2C%5B55.44%2C211.781%2C289.437%2C220.688%5D%2C%5B55.082%2C199.826%2C289.444%2C208.733%5D%2C%5B55.44%2C187.871%2C291.185%2C196.778%5D%2C%5B55.131%2C175.916%2C291.094%2C184.823%5D%2C%5B55.44%2C163.961%2C291.215%2C172.868%5D%2C%5B55.44%2C152.006%2C289.437%2C160.913%5D%2C%5B55.44%2C140.05%2C289.788%2C148.957%5D%2C%5B55.44%2C128.095%2C291.091%2C137.002%5D%2C%5B55.44%2C116.14%2C289.438%2C125.047%5D%2C%5B55.44%2C104.185%2C289.436%2C113.092%5D%2C%5B55.44%2C92.23%2C119.091%2C101.137%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=Y3JBRINU">“Another important related work is the previous LLaMA Long (Xiong et al., 2023) work and the concurrent XVERSE (XVerse, 2024) work, which continue pretraining the model on 32K sequences for about 500 billion tokens. These works are implicitly motivated by the view that longcontext modeling is a new capability that must be “injected” through large-scale training. We instead hypothesize that the base model has mostly already acquired this capability through large-scale pretraining, and thus a lightweight continual pretraining on relatively small data (e.g., 5B tokens) is enough to extend these capabilities to much longer context lengths (Fig. 3).”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 与另一种观点对比，另一种观点是大模型的长上下文能力是通过大规模的继续预训练注入的。

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22LZLDCTVD%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B306.972%2C527.153%2C541.613%2C536.06%5D%2C%5B307.44%2C515.198%2C543.093%2C524.105%5D%2C%5B307.44%2C503.243%2C543.096%2C512.15%5D%2C%5B307.44%2C491.288%2C541.437%2C500.195%5D%2C%5B307.44%2C479.332%2C542.687%2C488.239%5D%2C%5B307.092%2C467.377%2C543.096%2C476.284%5D%2C%5B307.44%2C455.422%2C350.049%2C464.329%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=LZLDCTVD">“We use the SlimPajama (Soboleva et al., 2023) dataset for continual pretraining. This dataset is an open-source reproduction of the LLaMA (Touvron et al., 2023a) pretraining data mixture, consisting of 82% web data (67% from CommonCrawl and 15% from C4), 4.5% code (Github), 4.5% Wikipedia, 4.5% books, 2.5% Arxiv, and 2.0% StackExchange.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 本文使用的SlimPajama数据集的构成

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22YRFJETBI%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B354.611%2C455.422%2C541.437%2C464.329%5D%2C%5B307.44%2C443.467%2C543.092%2C452.374%5D%2C%5B307.44%2C431.512%2C541.438%2C440.419%5D%2C%5B307.44%2C419.556%2C524.027%2C428.463%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=YRFJETBI">“Since this dataset closely mirrors that used to pretrain the LLaMA models, there is less concern of distribution shift during continual pretraining; it is therefore used by many recent works like Fuzhao Xue &#x26; You (2023).”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 即本文继续预训练使用的数据集与llama预训练使用的数据集相比分布比较接近，偏移较少，对预训练权重影响不大。

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22N65J3N2C%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B422.195%2C341.848%2C541.445%2C350.755%5D%2C%5B307.44%2C329.893%2C541.437%2C338.8%5D%2C%5B307.44%2C317.938%2C541.437%2C326.845%5D%2C%5B307.44%2C305.982%2C543.093%2C314.889%5D%2C%5B307.44%2C294.027%2C462.53%2C302.934%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=N65J3N2C">“Directly upsampling long data changes the domain mixture, e.g., upsampling sequences longer than 100K will increase the portion of the books domain. Likewise, changes in the domain mixture will result in shifts of the length distribution.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 不能直接上采样，会改变不同邻域数据的混合比例\
🔤直接上采样长数据会改变域混合，例如，上采样序列大于100K会增加图书域的比例。同样，域混合的变化也会导致长度分布的变化。🔤

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22D7NT48L5%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%223%22%2C%22position%22%3A%7B%22pageIndex%22%3A2%2C%22rects%22%3A%5B%5B307.44%2C108.722%2C543.089%2C117.748%5D%2C%5B307.44%2C96.767%2C543.187%2C105.674%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=3&#x26;annotation=D7NT48L5">“Per-source Upsampling: This retains the domain mixture, then upsamples long documents within each domain.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%223%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 3</a></span>)</span> 核心做法

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22WGK374Y9%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%224%22%2C%22position%22%3A%7B%22pageIndex%22%3A3%2C%22rects%22%3A%5B%5B307.44%2C254.531%2C541.437%2C263.438%5D%2C%5B307.44%2C242.576%2C541.437%2C251.483%5D%2C%5B307.44%2C230.621%2C541.437%2C239.528%5D%2C%5B307.44%2C218.666%2C542.687%2C227.573%5D%2C%5B307.44%2C206.711%2C541.437%2C215.618%5D%2C%5B307.44%2C194.756%2C541.442%2C203.663%5D%2C%5B307.44%2C182.8%2C541.437%2C191.707%5D%2C%5B307.44%2C170.845%2C541.437%2C179.752%5D%2C%5B307.44%2C158.89%2C541.437%2C167.797%5D%2C%5B307.44%2C146.935%2C541.442%2C155.842%5D%2C%5B307.44%2C134.98%2C434.543%2C143.887%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%224%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=4&#x26;annotation=WGK374Y9">“For training, we use a constant learning rate 2e-5. We modify the base of RoPE positional encoding to adjust it to longer context, as in Xiong et al. (2023). We pack all data to 80K chunks regardless of the document boundary, following common practice (Raffel et al., 2020; Touvron et al., 2023a). We set the batch size to be 4M tokens. Note that this batch size is the same as training on 4K context length, as we increase the length of a chunk but decrease the number of chunks in a batch. We train the model on 5B tokens, which translates to 5B (size of data) / 4M (batch size) = 2000 optimization steps.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%224%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 4</a></span>)</span> 训练的一些超参数

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22WMY68AJ5%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%225%22%2C%22position%22%3A%7B%22pageIndex%22%3A4%2C%22rects%22%3A%5B%5B307.44%2C146.518%2C541.437%2C155.425%5D%2C%5B307.44%2C134.563%2C542.684%2C143.47%5D%2C%5B307.44%2C122.608%2C540.228%2C131.515%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%225%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=5&#x26;annotation=WMY68AJ5">“In Table 3 we show that our method not only improves precise retrieval, but maintains short context performance, evidenced by strong MMLU (Hendrycks et al., 2020) score”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%225%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 5</a></span>)</span> MMLU是一种短文本测评方法

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22M26JU5GR%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%226%22%2C%22position%22%3A%7B%22pageIndex%22%3A5%2C%22rects%22%3A%5B%5B95.518%2C367.941%2C289.437%2C376.848%5D%2C%5B55.44%2C355.986%2C289.437%2C364.893%5D%2C%5B55.44%2C344.031%2C289.437%2C352.938%5D%2C%5B55.44%2C332.075%2C289.436%2C340.982%5D%2C%5B55.44%2C320.12%2C291.093%2C329.027%5D%2C%5B55.44%2C308.165%2C289.437%2C317.072%5D%2C%5B55.44%2C296.21%2C289.44%2C305.117%5D%2C%5B55.082%2C284.255%2C289.445%2C293.162%5D%2C%5B55.44%2C272.3%2C289.444%2C281.207%5D%2C%5B55.082%2C260.344%2C289.445%2C269.251%5D%2C%5B55.44%2C248.389%2C251.076%2C257.296%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%226%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=6&#x26;annotation=M26JU5GR">“Our method outperforms LongLoRA and Yarn Mistral (even though Mistral 7B is a stronger base model than LLaMA 2 7B we use). Our 13B model performance closes the gap to GPT-4 128K, and we anticipate that future scaling and instruction tuning will further improve performance. While there are other long-context benchmarks in InfiniBench (Zhang et al., 2023), in our initial experiments we found that models often had trouble understanding the instruction (because they are not instruction tuned). Hence we focus on the BookQA benchmark where base LLMs performed reasonably without instruction tuning.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%226%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 6</a></span>)</span> 其它的长上下午基准程序都是基于指令的，但本文并没有对模型进行instruct tune 因此模型难以理解指令。

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22ANHTQP8Z%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%226%22%2C%22position%22%3A%7B%22pageIndex%22%3A5%2C%22rects%22%3A%5B%5B172.563%2C180.693%2C289.438%2C189.6%5D%2C%5B55.44%2C168.738%2C291.098%2C177.645%5D%2C%5B55.44%2C156.783%2C289.438%2C165.69%5D%2C%5B55.44%2C144.828%2C291.185%2C153.735%5D%2C%5B55.44%2C132.873%2C291.093%2C141.78%5D%2C%5B55.44%2C120.918%2C289.439%2C129.825%5D%2C%5B55.44%2C108.962%2C289.437%2C117.869%5D%2C%5B55.082%2C97.007%2C289.436%2C105.914%5D%2C%5B55.44%2C85.052%2C226.428%2C93.959%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%226%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=6&#x26;annotation=ANHTQP8Z">“Our hypothesis is that precise retreival over long-range context is an intrinsic capability obtained by large-scale pretraining, even when the pretraining context length is substantially shorter (4K in many cases). If this hypothesis is true, then lightweight continual pretraining should be enough to extend this capability to much longer context lengths than see in training. That is, we would not need data-intensive continual pretraining as used by Xiong et al. (2023) and XVerse (2024).”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%226%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 6</a></span>)</span> 本文的观点

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22YD6ZRCBU%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%226%22%2C%22position%22%3A%7B%22pageIndex%22%3A5%2C%22rects%22%3A%5B%5B467.894%2C236.182%2C543.09%2C245.089%5D%2C%5B307.44%2C224.227%2C541.438%2C233.134%5D%2C%5B307.44%2C212.272%2C543.09%2C221.179%5D%2C%5B307.44%2C200.317%2C543.093%2C209.224%5D%2C%5B307.44%2C188.361%2C541.442%2C197.268%5D%2C%5B307.44%2C176.406%2C353.443%2C185.313%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%226%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=6&#x26;annotation=YD6ZRCBU">“At 500M to 1B tokens, the model achieves relatively good performance within its continually pretrained 80K context, but does not generalize to 80K-128K range. After 5B tokens, the model performs well on 0-80K, and can generalize to unseen lengths 80K-128K.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%226%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 6</a></span>)</span> 数据集越大则模型的处理长上下文能力也越强，不过最终会收敛

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%227UAFKUN3%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%227%22%2C%22position%22%3A%7B%22pageIndex%22%3A6%2C%22rects%22%3A%5B%5B178.185%2C355.636%2C289.61%2C364.543%5D%2C%5B55.44%2C343.681%2C291.092%2C352.588%5D%2C%5B55.44%2C331.725%2C289.792%2C340.632%5D%2C%5B55.44%2C319.77%2C289.445%2C328.677%5D%2C%5B55.44%2C307.815%2C289.441%2C316.722%5D%2C%5B55.44%2C295.86%2C289.44%2C304.767%5D%2C%5B55.44%2C283.905%2C291.095%2C292.812%5D%2C%5B55.44%2C271.95%2C289.438%2C280.857%5D%2C%5B55.44%2C259.994%2C290.68%2C268.901%5D%2C%5B55.082%2C248.039%2C289.61%2C256.946%5D%2C%5B55.44%2C236.084%2C289.438%2C244.991%5D%2C%5B55.44%2C224.129%2C259.883%2C233.036%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=7&#x26;annotation=7UAFKUN3">“Our results suggest that for supervised finetuning, since training on long-context is substantially cheaper than previously thought, future work may dive deeper on the solutions for 100K length finetuning and reasoning, which so far has almost no open-source work to our knowledge. For pretraining research, currently there is no definite answer as to whether long-context continual pretraining should be combined with other capabilities, such as math (Azerbayev et al., 2023) and code (Chen et al., 2021), which typically require hundreds of billions of tokens. Our results suggest that long-context continual pretraining could be a separate stage after code and math pretraining.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 7</a></span>)</span> 对未来的展望，表示本文的方法可加入作为预训练的一环

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22HVNPP79N%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%227%22%2C%22position%22%3A%7B%22pageIndex%22%3A6%2C%22rects%22%3A%5B%5B229.489%2C168.388%2C289.444%2C177.295%5D%2C%5B55.44%2C156.433%2C289.438%2C165.34%5D%2C%5B55.44%2C144.478%2C290.27%2C153.385%5D%2C%5B55.44%2C132.523%2C289.692%2C141.43%5D%2C%5B55.44%2C120.567%2C289.442%2C129.474%5D%2C%5B55.44%2C108.612%2C289.442%2C117.519%5D%2C%5B55.44%2C96.657%2C161.276%2C105.564%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=7&#x26;annotation=HVNPP79N">“Recall that this strategy keeps the mixture ratio of the data sources the same as the original data, i.e., 67% CommonCrawl (CC), 15% C4, 4.5% Github, 4.5% Wikipedia, 4.5% books, 2.5% Arxiv and 2.0% StackExchange for SlimPajama. Then in each of the domains, we upsample sequences longer than 4K from about 30% to about 70%.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 7</a></span>)</span> 注意是每一个邻域中都分别进行上采样

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22ELC3SDEK%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%227%22%2C%22position%22%3A%7B%22pageIndex%22%3A6%2C%22rects%22%3A%5B%5B462.352%2C367.591%2C541.792%2C376.498%5D%2C%5B307.44%2C355.636%2C543.093%2C364.543%5D%2C%5B307.44%2C343.681%2C541.438%2C352.588%5D%2C%5B307.44%2C331.725%2C541.437%2C340.632%5D%2C%5B307.44%2C319.77%2C383.076%2C328.677%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=7&#x26;annotation=ELC3SDEK">“In contrast, globally upsampling long sequences (without considering their domain), or intentionally upsampling code/ book/ Arxiv (since they are long) changes both the domain mixture and the length distribution.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 7</a></span>)</span> per-source上采样只改变了训练数据集的长度分布，而其余的这些方法不仅改变了长度分布，也改变了邻域的混合比例

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22LSKDMQV5%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%227%22%2C%22position%22%3A%7B%22pageIndex%22%3A6%2C%22rects%22%3A%5B%5B307.131%2C212.174%2C541.44%2C221.081%5D%2C%5B307.44%2C200.219%2C543.093%2C209.126%5D%2C%5B307.44%2C188.263%2C541.438%2C197.17%5D%2C%5B307.44%2C176.308%2C543.093%2C185.215%5D%2C%5B307.44%2C164.353%2C542.687%2C173.26%5D%2C%5B307.44%2C152.398%2C430.703%2C161.305%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=7&#x26;annotation=LSKDMQV5">“Table 5 compares the per-domain loss differences of all the data mixture against the baseline original mixture. We report the differences of the validation loss, where a more than 0.01 loss change is considered significant, following common pretraining practice (Kaplan et al., 2020; Peng et al., 2023; Hoffmann et al., 2022).”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%227%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 7</a></span>)</span> 通过对比实现来说明per-source是最平衡的一种方法，不会提高太多短文本的损失

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%229NI36D2A%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%228%22%2C%22position%22%3A%7B%22pageIndex%22%3A7%2C%22rects%22%3A%5B%5B87.159%2C218.249%2C289.44%2C227.156%5D%2C%5B55.44%2C206.294%2C289.61%2C215.201%5D%2C%5B55.44%2C194.339%2C289.437%2C203.246%5D%2C%5B55.44%2C182.384%2C291.096%2C191.291%5D%2C%5B55.44%2C170.429%2C289.793%2C179.336%5D%2C%5B55.44%2C158.473%2C289.437%2C167.38%5D%2C%5B55.44%2C146.518%2C291.18%2C155.425%5D%2C%5B55.131%2C134.563%2C289.788%2C143.47%5D%2C%5B55.44%2C122.608%2C289.438%2C131.515%5D%2C%5B55.44%2C110.653%2C289.437%2C119.56%5D%2C%5B55.44%2C98.698%2C289.44%2C107.605%5D%2C%5B55.44%2C86.742%2C130.983%2C95.649%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%228%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=8&#x26;annotation=9NI36D2A">“Note that LongLoRA (Chen et al., 2023b) uses the original data mixture without length upsampling, so our results also explains why we achieve better performance than LongLoRA (Fig. 1). We see that the original data mixture without length upsampling, despite achieving a very close loss, underperforms on precise retrieval. Per-source length upsampling significantly improves precise retrieval. This observation also serves as strong evidence why only using test loss, the evaluation used in most prior work (Chen et al., 2023a; Peng et al., 2023; Chen et al., 2023b; Xiao et al., 2023; Anthropic, 2023), may conceal the underlying model differences.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%228%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 8</a></span>)</span> 没有上采样虽然损失相近，但是在干草堆任务上表现不佳。因此如果只是使用损失来进行模型的评估显然是片面的，这会掩盖模型潜在的差异。

<span class="highlight" data-annotation="%7B%22attachmentURI%22%3A%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FZ5AQISDH%22%2C%22annotationKey%22%3A%22U4JVRYZG%22%2C%22color%22%3A%22%23ff6666%22%2C%22pageLabel%22%3A%228%22%2C%22position%22%3A%7B%22pageIndex%22%3A7%2C%22rects%22%3A%5B%5B307.44%2C346.752%2C541.437%2C355.659%5D%2C%5B307.44%2C334.797%2C541.437%2C343.704%5D%2C%5B307.44%2C322.841%2C541.438%2C331.748%5D%2C%5B307.44%2C310.886%2C543.098%2C319.793%5D%2C%5B307.44%2C298.931%2C541.438%2C307.838%5D%2C%5B307.44%2C286.976%2C543.093%2C295.883%5D%2C%5B307.44%2C275.021%2C541.442%2C283.928%5D%2C%5B307.082%2C263.066%2C528.939%2C271.973%5D%5D%7D%2C%22citationItem%22%3A%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%228%22%7D%7D" ztype="zhighlight"><a href="zotero://open-pdf/library/items/Z5AQISDH?page=8&#x26;annotation=U4JVRYZG">“Long-context language model research at the 100K-level is still a developing research area. This work only studies continual pretraining, and research on instruction finetuning language models on tasks of 100K context length (e.g., repolevel code understanding) is still limited. So far there seems to no open-source instruction-finetuned 100K context language models. We hope our work serve as a basis for future work on 100K-level long context superivsed finetuning.”</a></span> <span class="citation" data-citation="%7B%22citationItems%22%3A%5B%7B%22uris%22%3A%5B%22http%3A%2F%2Fzotero.org%2Fusers%2F10533898%2Fitems%2FP3J78PXW%22%5D%2C%22locator%22%3A%228%22%7D%5D%2C%22properties%22%3A%7B%7D%7D" ztype="zcitation">(<span class="citation-item"><a href="zotero://select/library/items/P3J78PXW">Fu 等, 2024, p. 8</a></span>)</span> 100k级别上下文的微调仍然是一个问题

## <span style="color: #4A148C"><span style="background-color: #f5f5f5">🚩 研究结论</span></span>

***

<span style="color: rgb(6, 6, 7)"><span style="background-color: rgb(255, 255, 255)">论文总结了研究成果，指出通过持续预训练可以有效地扩展语言模型的上下文长度，并为未来的长上下文指令微调研究奠定了基础。</span></span>

## <span style="color: #006064"><span style="background-color: #e0f7fa">📌 感想 &#x26; 疑问</span></span>

***

这篇论文提出了一种通过数据工程的方法来进行长下文建模，主要是通过加长继续预训练的上下文长度，并且选用新的混合邻域数据集，对每一个邻域都进行长文本的上采样，从而提高了数据质量，实验证明通过这种方法得到的模型在干草堆实验上的效果与chatgpt接近，并且不会损失太多在短文本上的性能。

